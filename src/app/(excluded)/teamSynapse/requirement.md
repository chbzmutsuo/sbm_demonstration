## 1. プロジェクト概要

### 1.1. 目的

本プロジェクトの目的は、Google Workspace環境（Gmail, Google Drive, Google Chat）における特定の人物（例：部下）とのコミュニケーション履歴をAIで横断的に分析するWebアプリケーションを開発することです。

分析結果に基づき、関係構築、業務推進、タスクの抜け漏れ防止に役立つ「客観的な気づき」と「具体的なネクストアクション」を提案します。

### 1.2. 解決したい課題

- **1on1の形骸化:** マネージャーが部下との1on1に臨む際、具体的なエピソードや事実に基づいたフィードバックができず、抽象的な会話に終始してしまう。
- **タスク把握の属人化:** メールやチャットに散在する「依頼したタスク」「報告された懸念」を見落とし、適切なフォローアップができない。
- **貢献の可視化:** 日々の業務で部下が達成した成果や、迅速な対応（賞賛すべき点）がコミュニケーションノイズに埋もれ、正当な評価や感謝を伝えるタイミングを逃してしまう。
- 宙に浮いたボール（仕事の責任やタスク）を把握し、適切な人にアサインする

## 2. システムアーキテクチャ

**クライアントサイド完結型アプリケーション**として構築します。

- **実行環境:** ユーザーのWebブラウザ
- **認証:** Google Identity Services (GIS) を用いたOAuth 2.0

```
[ユーザー（ブラウザ: index.html）]
    |
    | 1. OAuth認証 (Google Identity Services)
    v
[Google Cloud Platform]
    |
    +--> [Gmail API]   <-- 2a. メール検索・取得
    |
    +--> [Drive API]   <-- 2b. Docs/Slideテキスト抽出
    |
    +--> [Chat API]    <-- 2c. Chat履歴取得 (※最重要・前提条件あり)
    |
    v
[ユーザー（ブラウザ）]
    |
    | 3. 全データを共通JSONに整形
    v
[Gemini API] (generativelanguage.googleapis.com)
    |
    | 4. AI分析 (3ステップ実行)
    v
[ユーザー（ブラウザ）]
    |
    | 5. 分析結果・アクションをUIに描画
    v
[UI (index.html)]

```

## 3. 技術要件と最重要前提条件

### 3.1. 使用ライブラリ・API

- **UI:** Tailwind CSS (CDN: `https://cdn.tailwindcss.com`)
- **認証:** Google Identity Services (GIS) Library (`https://accounts.google.com/gsi/client`)
- **Google API:**
  - Gmail API (v1)
  - Google Drive API (v3)
  - Google Chat API (v1)
- **AI:** Gemini API (`gemini-2.5-flash-preview-09-2025` を推奨)

### 3.2. OAuth 2.0 要求スコープ

認証時に、以下の**3つすべてのスコープ**をユーザーに要求し、同意を得る必要があります。

1. `https://www.googleapis.com/auth/gmail.readonly` (Gmail履歴の読み取り)
2. `https://www.googleapis.com/auth/drive.readonly` (Gmailに添付されたDriveファイルの読み取り)
3. `https://www.googleapis.com/auth/chat.messages.readonly` (指定されたChatルームの履歴読み取り)

### 3.3. 【最重要】Google Chat API 利用の前提条件

**Chat分析機能は、以下の条件が満たされない限り動作しません。** この前提に基づきUI（ルームID入力欄）を設計してください。

1. **GCPでのChatアプリ（ボット）構成（開発者作業）:**
   - 開発者はGCPで「Google Chat API」を有効化します。
   - Chat APIの「構成」画面で、ボット名（例: "Analyzer Bot"）、アバター等を設定し、組織内に公開します。
   - **注意:** このボットはサーバーロジックを持つ必要はなく、APIアクセス権限の「定義」としてのみ機能します。
2. **ユーザーによるボット招待（ユーザー作業）:**
   - **本システムの利用前**に、ユーザー（マネージャー）は、分析したいGoogle Chatの各ルーム（グループ会話）に、(1)で定義された "Analyzer Bot" を**手動で招待**する必要があります。
   - ボットが招待されていないルームの履歴は、`chat.messages.readonly` スコープがあっても取得**できません**。

## 4. UI・機能設計

### 4.1. 入力コンポーネント

以下の入力フィールドを設置します。

1. **相手のメールアドレス (必須 / 複数可能):**
   - `type="email"`
   - Gmail検索 (`from/to/cc`) およびChatの履歴紐付けに使用します。
2. **期間 (From / To) (必須):**
   - `type="date"`
   - 全API（Gmail, Chat）の検索期間として指定します。
3. **Google Chat ルームID (任意):**
   - `type="text"`
   - `placeholder="例: spaces/AAAAxxxxxxx"`
   - **UI上の注記 (必須):** 「※分析対象ルームに "Analyzer Bot" が招待されている必要があります。」というヘルプテキストを必ず表示してください。

### 4.2. 出力コンポーネント

分析結果は、2カラム（`lg:grid-cols-2`）で表示します。

1. **AIによる分析結果（左側）:**
   - AIが動的に提案した「観点」ごと（例：「佐藤様対応の状況」）に、ポップなデザインのカード（パステル背景色、アイコン付き）で表示します。
   - 観点内の事実は、チェックマークアイコン付きのリストで表示します。
2. **ネクストアクション提案（右側）:**
   - 「カテゴリ」（感謝、確認、指導など）ごとに、アイコンとアクセントカラー付きのカードで表示します。

## 5. データ処理フローとAIプロンプト設計

「分析実行」ボタン押下後、以下のステップを非同期で実行します。

### Step 0: データ収集と整形

1. **Gmail API:** `q=(from:A OR to:A OR cc:A) after:X before:Y` でメールリストを取得し、各メール本文を取得します。
2. **Drive API:** (1)のメールに添付されたDocs/Slideの `fileId` を取得し、`files.export` (mimeType: `text/plain`) でテキストデータを抽出します。
3. **Chat API:** ユーザーが「Chat ルームID」を入力した場合のみ、`v1/{parent=spaces/ID}/messages` (filter: `createTime >= X AND createTime <= Y`) で履歴を取得します。
4. **整形:** 上記 1, 2, 3 で得られたすべてのテキストデータを、以下の**共通JSON形式**の配列に統一します。

```
/* Step 0: AIへの入力データ（共通形式） */
[
  {
    "source": "gmail",
    "id": "msg-123",
    "date": "2025-01-15T10:30:00Z",
    "from": "相手のアドレス",
    "to": "あなたのアドレス",
    "body": "（Gmail本文のクレンジング済みテキスト）"
  },
  {
    "source": "chat",
    "id": "msg-abc",
    "date": "2025-01-16T11:00:00Z",
    "from": "相手のアドレス",
    "body": "（Chat本文のテキスト）"
  },
  {
    "source": "drive_docs",
    "id": "file-fgh",
    "date": "2025-01-17T15:00:00Z",
    "title": "（Docsのタイトル）",
    "body": "（Docsから抽出した全文テキスト）"
  }
]

```

### Step 1: 【AI Call 1】 観点提案

- **目的:** 全履歴から、注目すべきトピック（観点）をAIに抽出させる。
- **プロンプト:**

  ```
  あなたはプロのビジネスアナリストです。
  以下のコミュニケーション履歴（JSON）を読み込み、マネージャーが特に注目すべき「主要な観点（トピック、案件名、行動特性など）」を3〜5個提案してください。

  # 制約
  - 出力は必ず以下のJSON形式とすること。
  - "viewpoints": ["観点1", "観点2", "観点3"]

  # 入力データ
  [Step 0 で整形したJSONデータ]

  ```

- **AI出力（期待値）:**

  ```
  {"viewpoints": ["佐藤様対応の状況", "新型車『雅』の進捗", "報告の迅速性"]}

  ```

### Step 2: 【AI Call 2】 事実分析

- **目的:** Step 1で定義した観点に基づき、具体的な事実を履歴から抽出させる。
- **プロンプト:**

  ```
  あなたはプロのビジネスアナリストです。
  以下の入力データ（JSON）に基づき、指定された「分析観点」ごとに、関連する具体的な「事実」を入力データから抽出してください。

  # 分析観点
  - 佐藤様対応の状況
  - 新型車『雅』の進捗
  - 報告の迅速性

  # 制約
  - 出力は必ず以下のJSON形式とすること。
  - 各観点に対する事実は、入力データから抽出した具体的な内容を3〜5個の箇条書き（文字列配列）でまとめること。
  - {
      "佐藤様対応の状況": ["（事実1）", "（事実2）"],
      "新型車『雅』の進捗": ["（事実3）", "（事実4）"],
      "報告の迅速性": ["（事実5）"]
    }

  # 入力データ
  [Step 0 で整形したJSONデータ]

  ```

- **AI出力（期待値）:**

  ```
  {
    "佐藤様対応の状況": [
      "1月20日のメール(msg-123)にて、佐藤様からご指摘（クレーム）があった。",
      "1月21日のチャット(msg-abc)で、迅速に対応完了した旨の報告があった。"
    ],
    "新型車『雅』の進捗": [
      "共有文書(file-fgh)にて、先行予約リストが作成・更新されている。",
      "1月22日のメールで、試乗会の準備が完了したと報告があった。"
    ],
    "報告の迅速性": [
      "佐藤様の件(msg-abc)について、問題発生から1日以内に対応完了報告が行われている。"
    ]
  }

  ```

### Step 3: 【AI Call 3】 行動提案

- **目的:** Step 2の分析結果に基づき、具体的なアクションを提案させる。
- **プロンプト:**

  ```
  あなたは経験豊富な営業マネージャーです。
  以下の「事実分析レポート」（JSON）に基づき、部下（相手）に対して取るべき「ネクストアクション」を3〜5個提案してください。

  # 制約
  - アクションは「カテゴリ」（例：感謝・労い、確認・懸念、指導・助言、関係構築）と「具体的な提案」で構成すること。
  - 出力は必ず以下のJSON形式とすること。
  - {
      "actions": [
        {"category": "感謝・労い", "suggestion": "（具体的な提案1）"},
        {"category": "確認・懸念", "suggestion": "（具体的な提案2）"}
      ]
    }

  # 事実分析レポート
  [Step 2 でAIが出力したJSONデータ]

  ```

- **AI出力（期待値）:**

  ```
  {
    "actions": [
      {
        "category": "感謝・労い",
        "suggestion": "佐藤様からのご指摘の件、迅速な報告と鎮火対応を高く評価していると伝える。"
      },
      {
        "category": "確認・懸念",
        "suggestion": "新型車『雅』の試乗会準備について、何か懸念点やサポートが必要か確認する。"
      },
      {
        "category": "関係構築",
        "suggestion": "日々の迅速な報告が非常に助かっていると、具体的に感謝を伝える。"
      }
    ]
  }

  ```

## 6. 推奨実装ステップ

1. **UIと認証の構築:**
   - HTMLでUI（入力欄、結果表示エリア）の静的レイアウトを作成します。
   - Google GISライブラリを導入し、3つのスコープ（Gmail, Drive, Chat）でOAuth認証を完了させます。
2. **Gmail分析の実装:**
   - まずGmail APIのデータ取得と、AI分析（Step 0〜3）のフローを実装します。この時点でコア機能は動作します。
3. **Drive連携の実装:**
   - Gmailの添付ファイルIDを処理し、Drive API (`files.export`) を呼び出すロジックを追加します。Step 0 の整形データに "drive_docs" が追加されます。
4. **Chat連携の実装:**
   - 【最重要前提】GCPでChatアプリを構成した後、UI（ルームID入力欄）を実装します。
   - Chat APIを呼び出すロジックを追加し、Step 0 の整形データに "chat" が追加されます。
5. **UIの動的描画:**
   - Step 3のAI出力を受け取り、ポップなカードデザイン（`detailed_design_v1.md` 参照）で描画するロジックを実装します。
